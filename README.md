This is borrowing more or less directly from isabelroses
